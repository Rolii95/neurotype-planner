name: Run Supabase Migration

on:
  workflow_dispatch: {}

jobs:
  run-migration:
    name: Run idempotent migration on hosted runner
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary sqlparse

      - name: Prepare and run idempotent migration
        env:
          DB_HOST: ${{ secrets.SUPABASE_DB_HOST }}
          DB_PORT: ${{ secrets.SUPABASE_DB_PORT }}
          DB_USER: ${{ secrets.SUPABASE_DB_USER }}
          DB_PASS: ${{ secrets.SUPABASE_DB_PASSWORD }}
          DB_NAME: ${{ secrets.SUPABASE_DB_NAME }}
        run: |
          set -euo pipefail
          python scripts/make_idempotent.py
          python scripts/apply_manual_fixes.py --host "$DB_HOST" --port "$DB_PORT" --user "$DB_USER" --password "$DB_PASS" --dbname "$DB_NAME"

      - name: List generated artifacts for debugging
        run: |
          echo "Files in scripts/"
          ls -la scripts || true

      - name: Upload migration logs
        uses: actions/upload-artifact@v4
        with:
          name: migration-logs
          path: |
            scripts/fix_rerun_log.txt
            scripts/attempted_fix_*.sql
